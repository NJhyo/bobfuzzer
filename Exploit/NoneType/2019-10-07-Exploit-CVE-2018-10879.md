---
layout: post
title: "malloc.c Analysis"
author: "nonetype"
---

# Î™©Ï∞®

1. TOC
{:toc}

---

# Vulnerability Analysis
Ìï¥Îãπ Ï∑®ÏïΩÏ†êÏùÄ `lost+found entry`Í∞Ä `allocation bitmap`ÏúºÎ°ú ÌôïÏù∏ÎêòÏñ¥ `buffer_verified` ÌîåÎûòÍ∑∏Í∞Ä ÏÑ§Ï†ïÎêòÍ≥†, `ext4_rename` Ìï®Ïàò ÎÇ¥ÏóêÏÑú `old_dentry`Î•º ÏÇ≠Ï†úÌïòÎäî Í≥ºÏ†ï Ï§ë, Ï†ÅÌï©Ìïú ÏÇ¨Ïù¥Ï¶àÏùò `xattr entry`Î•º Ï∞æÏúºÎ†§ ÌååÏùº ÏãúÏä§ÌÖú ÎÇ¥Ïùò ÏóîÌä∏Î¶¨Î•º ÏàúÌöåÌïòÎäî Ï§ë `lost+found entry`Í∞Ä `xattr entry`Í∞Ä ÏïÑÎãòÏóêÎèÑ Î∂àÍµ¨ÌïòÍ≥† `buffer_verified` ÌîåÎûòÍ∑∏ Ï≤¥ÌÅ¨Í∞Ä ÎêòÏñ¥ÏûàÏúºÎØÄÎ°ú `xattr entry`Î°ú Ïò§Ïù∏ÎêòÏñ¥ Ìï¥Îãπ ÏóîÌä∏Î¶¨ ÏòÅÏó≠ÏùÑ searchÌïòÍ≥†, Ìï¥Îãπ ÏòÅÏó≠Ïóê Ï°¥Ïû¨ÌïòÎäî Ïä§ÌîÑÎ†àÏûâ Îêú Í∞í `offset`ÏúºÎ°ú Ï∞∏Ï°∞ÌïòÏó¨ Îã§Ïùå `Entry`Î•º Ï∞æÏúºÎØÄÎ°ú Ïó∞Í≤∞ Î¶¨Ïä§Ìä∏Ïùò offsetÏù¥ heap Î©îÎ™®Î¶¨Ïóê Ìï†ÎãπÎêú `[s->base] ~ [s->end]` ÏòÅÏó≠ÏùÑ Î≤óÏñ¥ÎÇò Îã§Î•∏ Ïª§ÎÑê Ïò§Î∏åÏ†ùÌä∏Î•º Ï∞∏Ï°∞Ìï®ÏúºÎ°úÏç® Î∞úÏÉùÌïòÎäî `Slab-OOB` Ï∑®ÏïΩÏ†êÏù¥Îã§.

## ext4_xattr_block_find()
ÏàúÌöå Ï§ë Ï∞∏Ï°∞ÌïòÎäî `ext4_xattr_block_find->ext4_xattr_search` Íµ¨Ï°∞Ï≤¥Îäî `ext4_xattr_block_find()` Ìï®ÏàòÏóêÏÑú ÌïÑÎìú Í∞íÏùÑ Ï±ÑÏõåÏ§ÄÎã§.


```c
static int
ext4_xattr_block_find(struct inode *inode, struct ext4_xattr_info *i,
		      struct ext4_xattr_block_find *bs)
{
		bs->bh = sb_bread(sb, EXT4_I(inode)->i_file_acl);
                ...
                ...
		/* Find the named attribute. */
		/*
		#define BHDR(bh) ((struct ext4_xattr_header *)((bh)->b_data))
		*/
		bs->s.base = BHDR(bs->bh);
		/*
		#define BFIRST(bh) ENTRY(BHDR(bh)+1)
		*/
		bs->s.first = BFIRST(bs->bh);
		bs->s.end = bs->bh->b_data + bs->bh->b_size;
		bs->s.here = bs->s.first;
		error = xattr_find_entry(inode, &bs->s.here, bs->s.end,
					 i->name_index, i->name, 1);
		if (error && error != -ENODATA)
			goto cleanup;
		bs->s.not_found = error;
                ...
```

ÏïÑÎûòÎäî `bs->s.base = BHDR(bs->bh);` ÏΩîÎìúÍ∞Ä Ïã§ÌñâÎêòÍ∏∞ Ï†Ñ ÌôïÏù∏Ìïú `bs`ÏôÄ `bs->bh` Íµ¨Ï°∞Ï≤¥ ÌïÑÎìúÏù¥Îã§.
Ïú†ÏùòÍπäÍ≤å Î¥êÏïº ÌïòÎäî Ï†êÏùÄ, `bs->bh->b_state` Í∞íÏù¥ `0x4000021`ÏúºÎ°ú, `buffer_verified` ÌîåÎûòÍ∑∏(`0x4000000`)Í∞Ä ÏÑ§Ï†ïÎêòÏóàÎã§Îäî Í≤ÉÍ≥º Heap ÏòÅÏó≠Ïóê Ìï†ÎãπÎêòÎäî Íµ¨Ï°∞Ï≤¥Ïùò ÌÅ¨Í∏∞ `bs->bh->b_size`Í∞Ä `0x400`Ïù¥ÎùºÎäî Ï†êÏù¥Îã§.

```sh
gef‚û§  p *$2
$3 = {
  s = {
    first = 0x0 <irq_stack_union>,
    base = 0x0 <irq_stack_union>,
    end = 0x0 <irq_stack_union>,
    here = 0x0 <irq_stack_union>,
    not_found = 0xffffffc3
  },
  bh = 0xffff88007bf714e0
}
gef‚û§  p *$2->bh
$4 = {
  b_state = 0x4000021,
  b_this_page = 0xffff88007bf71680,
  b_page = 0xffffea0001eaac80,
  b_blocknr = 0x23,
  b_size = 0x400,
  b_data = 0xffff88007aab2c00 "\002",
  b_bdev = 0xffff88007cc28340,
  b_end_io = 0x0 <irq_stack_union>,
  b_private = 0x0 <irq_stack_union>,
  b_assoc_buffers = {
    next = 0xffff88007bf71528,
    prev = 0xffff88007bf71528
  },
  b_assoc_map = 0x0 <irq_stack_union>,
  b_count = {
    counter = 0x2
  }
}
```

ÏïÑÎûòÎäî ÌïÑÎìú Ìï†Îãπ ÌõÑÏùò Íµ¨Ï°∞Ï≤¥Ïùò Î™®ÏäµÏù¥Îã§.
`bs->s->base`ÏôÄ `bs->s->end`Í∞Ä ÏÑ§Ï†ïÎêòÏñ¥ Heap ÏòÅÏó≠Ïóê Ìï†ÎãπÎêú Íµ¨Ï°∞Ï≤¥Ïùò Î≤îÏúÑÎ•º Ïïå Ïàò ÏûàÏóàÍ≥†, `first`ÏôÄ `here` ÌïÑÎìúÍ∞Ä `lost+found entry`Î•º Í∞ÄÎ•¥ÌÇ§Î©∞, `NEXT(first)` Ïó∞ÏÇ∞Ïù¥ Î™á Ï∞®Î°Ä Ïù¥Î£®Ïñ¥ÏßÄÎ©¥ `0x9b9b9b9b` ÏòÅÏó≠ÏùÑ Ï∞∏Ï°∞Ìï† Ïàò ÏûàÏùåÏùÑ Ïïå Ïàò ÏûàÎã§.

```sh
gef‚û§  p *$2
$6 = {
  s = {
    first = 0xffff88007aab2c20,
    base = 0xffff88007aab2c00,
    end = 0xffff88007aab3000,
    here = 0xffff88007aab2c20,
    not_found = 0xffffffc3
  },
  bh = 0xffff88007bf714e0
}
gef‚û§  p *$2->bh
$5 = {
  b_state = 0x4000021,
  b_this_page = 0xffff88007bf71680,
  b_page = 0xffffea0001eaac80,
  b_blocknr = 0x23,
  b_size = 0x400,
  b_data = 0xffff88007aab2c00 "\002",
  b_bdev = 0xffff88007cc28340,
  b_end_io = 0x0 <irq_stack_union>,
  b_private = 0x0 <irq_stack_union>,
  b_assoc_buffers = {
    next = 0xffff88007bf71528,
    prev = 0xffff88007bf71528
  },
  b_assoc_map = 0x0 <irq_stack_union>,
  b_count = {
    counter = 0x2
  }
}

gef‚û§  x/128gx 0xffff88007aab2c00
0xffff88007aab2c00:	0x0201000c00000002	0x000000020000002e
0xffff88007aab2c10:	0x00002e2e0202000c	0x020a00140000000b
0xffff88007aab2c20:	0x756f662b74736f6c	0x0000000c0000646e
0xffff88007aab2c30:	0x006f6f660203000c	0x0201000c00000013
0xffff88007aab2c40:	0x0000005200000061	0x000000300101000c
0xffff88007aab2c50:	0x0101000c00000053	0x0000005400000031
0xffff88007aab2c60:	0x000000320101000c	0x0101000c00000055
0xffff88007aab2c70:	0x0000005600000033	0x000000340101000c
0xffff88007aab2c80:	0x0101000c00000057	0x0000005800000035
0xffff88007aab2c90:	0x000000360101000c	0xbabeccccbbaa0059
0xffff88007aab2ca0:	0xffffdeadbeefcafe	0x9b9b9b9b9b9bffff
0xffff88007aab2cb0:	0x9b9b9b9b9b9b9b9b	0x9b9b9b9b9b9b9b9b
0xffff88007aab2cc0:	0x9b9b9b9b9b9b9b9b	0x9b9b9b9b9b9b9b9b
0xffff88007aab2cd0:	0x9b9b9b9b9b9b9b9b	0x9b9b9b9b9b9b9b9b
...
0xffff88007aab2ff0:	0x9b9b9b9b9b9b9b9b	0x9b9b9b9b9b9b9b9b
0xffff88007aab3000:	0x0000000000000000	0x0000000000000000
```

## ext4_xattr_set_entry()

`ext4_xattr_set_entry()` Ìï®ÏàòÏóêÏÑúÎäî

```
                                                       +--------------------+
                                                       |                    |
                                                       |                    |
                                                       |                    |
            ENTRY 01           ENTRY 02                |                    |
      +------------+-----+------------+-----+          |                    |
      |            |     |            |     |          |    OTHER OBJECT    |
      | e_name_len | ... | e_name_len | ... |          |                    |
      |            |     |            |     |          |                    |
      +------------+------------------+-----+          |                    |
      |                  ^                             |                    |
      |                  |                             |                    |
      |                  |                       +---->---------------------+
      +------------------+                       |     |                    |
                                                 |     |      ENTRY  N      |
    EXT4_XATTR_NEXT(ENTRY_01)                    |     |                    |
                                                 |     +--------------------+  <+ EXT4_XATTR_NEXT(ENTRY N-1)
((&ENTRY_01) + e_name_len + 0x0f)                |     |                    |
                                                 |     |      ENTRY N-1     |
                                                 |     |                    |
                                                 |     +--------------------+
                                                 |     *                    *
                                                 |     *                    *
                                                 |     *                    *
     struct ext4_xattr_search                    |     +--------------------+
                                                 |     |                    |
 +------------------------------+                |     |      ENTRY 03      |
 |            first             +-----+          |     |                    |
 +------------------------------+     |          |     +--------------------+ <+ EXT4_XATTR_NEXT(ENTRY 02)
 |            base              |     |          |     |                    |
 +------------------------------+     |          |     |      ENTRY 02      |
 |             end              +----------------+     |                    |
 +------------------------------+     |                +--------------------+ <+ EXT4_XATTR_NEXT(ENTRY 01)
 |            here              |     |                |                    |
 +------------------------------+     +--------------->+      ENTRY 01      |
 |          not_found           |                      |                    |
 +------------------------------+                      +--------------------+
31                            0
```



<!--
ÌÖåÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄ 0xD0a0 ÏúÑÏπòÏóê data entry Ï°¥Ïû¨. (0x44 )


gef‚û§  p *(struct ext4_xattr_entry *)0xffff8800799d04a4
$16 = {
  e_name_len = 0x4,
  e_name_index = 0x7,
  e_value_offs = 0x18,
  e_value_inum = 0x0,
  e_value_size = 0x44,
  e_hash = 0x0,
  e_name = 0xffff8800799d04b4 "data"
}


00 00 02 EA 04 07 18 00 00 00 00 00 44 00 00 00 00 00 00 00 64 61 74 61 00 00 00 00 0E 00 00 00 0C 00 03 01 68 6C 6E 00 12 00 00 00 38 00 03 07
ÔøΩÔøΩ√™ÔøΩÔøΩÔøΩÔøΩÔøΩDÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩdataÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩhlnÔøΩÔøΩÔøΩÔøΩ8ÔøΩ


Ìï¥Îãπ Í∞íÏù¥ controlable? Ï°∞Ï†à Í∞ÄÎä•ÌïòÎ©¥ ÎåÄÎ∞ïÏì∞ ÏïàÎê†Í∞ÄÎä•ÏÑ± ÎÜíÏùå
e_value_sizeÎäî Ï≤¥ÌÅ¨ Ï°¥Ïû¨ÌïòÎäîÎìØ
-->
