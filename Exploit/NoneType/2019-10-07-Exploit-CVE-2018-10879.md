---
layout: post
title: "malloc.c Analysis"
author: "nonetype"
---

# ëª©ì°¨

1. TOC
{:toc}

---

# Vulnerability Analysis
í•´ë‹¹ ì·¨ì•½ì ì€ `lost+found entry`ê°€ `allocation bitmap`ìœ¼ë¡œ í™•ì¸ë˜ì–´ `buffer_verified` í”Œë˜ê·¸ê°€ ì„¤ì •ë˜ê³ , `ext4_rename` í•¨ìˆ˜ ë‚´ì—ì„œ `old_dentry`ë¥¼ ì‚­ì œí•˜ëŠ” ê³¼ì • ì¤‘, ì í•©í•œ ì‚¬ì´ì¦ˆì˜ `xattr entry`ë¥¼ ì°¾ìœ¼ë ¤ íŒŒì¼ ì‹œìŠ¤í…œ ë‚´ì˜ ì—”íŠ¸ë¦¬ë¥¼ ìˆœíšŒí•˜ëŠ” ì¤‘ `lost+found entry`ê°€ `xattr entry`ê°€ ì•„ë‹˜ì—ë„ ë¶ˆêµ¬í•˜ê³  `buffer_verified` í”Œë˜ê·¸ ì²´í¬ê°€ ë˜ì–´ìˆìœ¼ë¯€ë¡œ `xattr entry`ë¡œ ì˜¤ì¸ë˜ì–´ í•´ë‹¹ ì—”íŠ¸ë¦¬ ì˜ì—­ì„ searchí•˜ê³ , í•´ë‹¹ ì˜ì—­ì— ì¡´ì¬í•˜ëŠ” ìŠ¤í”„ë ˆì‰ ëœ ê°’ `offset`ìœ¼ë¡œ ì°¸ì¡°í•˜ì—¬ ë‹¤ìŒ `Entry`ë¥¼ ì°¾ìœ¼ë¯€ë¡œ ì—°ê²° ë¦¬ìŠ¤íŠ¸ì˜ offsetì´ heap ë©”ëª¨ë¦¬ì— í• ë‹¹ëœ `[s->base] ~ [s->end]` ì˜ì—­ì„ ë²—ì–´ë‚˜ ë‹¤ë¥¸ ì»¤ë„ ì˜¤ë¸Œì íŠ¸ë¥¼ ì°¸ì¡°í•¨ìœ¼ë¡œì¨ ë°œìƒí•˜ëŠ” `Slab-OOB` ì·¨ì•½ì ì´ë‹¤.

## ext4_xattr_block_find()
ìˆœíšŒ ì¤‘ ì°¸ì¡°í•˜ëŠ” `ext4_xattr_block_find->ext4_xattr_search` êµ¬ì¡°ì²´ëŠ” `ext4_xattr_block_find()` í•¨ìˆ˜ì—ì„œ í•„ë“œ ê°’ì„ ì±„ì›Œì¤€ë‹¤.


```c
static int
ext4_xattr_block_find(struct inode *inode, struct ext4_xattr_info *i,
		      struct ext4_xattr_block_find *bs)
{
		bs->bh = sb_bread(sb, EXT4_I(inode)->i_file_acl);
                ...
                ...
		/* Find the named attribute. */
		/*
		#define BHDR(bh) ((struct ext4_xattr_header *)((bh)->b_data))
		*/
		bs->s.base = BHDR(bs->bh);
		/*
		#define BFIRST(bh) ENTRY(BHDR(bh)+1)
		*/
		bs->s.first = BFIRST(bs->bh);
		bs->s.end = bs->bh->b_data + bs->bh->b_size;
		bs->s.here = bs->s.first;
		error = xattr_find_entry(inode, &bs->s.here, bs->s.end,
					 i->name_index, i->name, 1);
		if (error && error != -ENODATA)
			goto cleanup;
		bs->s.not_found = error;
                ...
```

ì•„ë˜ëŠ” `bs->s.base = BHDR(bs->bh);` ì½”ë“œê°€ ì‹¤í–‰ë˜ê¸° ì „ í™•ì¸í•œ `bs`ì™€ `bs->bh` êµ¬ì¡°ì²´ í•„ë“œì´ë‹¤.
ìœ ì˜ê¹Šê²Œ ë´ì•¼ í•˜ëŠ” ì ì€, `bs->bh->b_state` ê°’ì´ `0x4000021`ìœ¼ë¡œ, `buffer_verified` í”Œë˜ê·¸(`0x4000000`)ê°€ ì„¤ì •ë˜ì—ˆë‹¤ëŠ” ê²ƒê³¼ Heap ì˜ì—­ì— í• ë‹¹ë˜ëŠ” êµ¬ì¡°ì²´ì˜ í¬ê¸° `bs->bh->b_size`ê°€ `0x400`ì´ë¼ëŠ” ì ì´ë‹¤.

```sh
gefâ¤  p *$2
$3 = {
  s = {
    first = 0x0 <irq_stack_union>,
    base = 0x0 <irq_stack_union>,
    end = 0x0 <irq_stack_union>,
    here = 0x0 <irq_stack_union>,
    not_found = 0xffffffc3
  },
  bh = 0xffff88007bf714e0
}
gefâ¤  p *$2->bh
$4 = {
  b_state = 0x4000021,
  b_this_page = 0xffff88007bf71680,
  b_page = 0xffffea0001eaac80,
  b_blocknr = 0x23,
  b_size = 0x400,
  b_data = 0xffff88007aab2c00 "\002",
  b_bdev = 0xffff88007cc28340,
  b_end_io = 0x0 <irq_stack_union>,
  b_private = 0x0 <irq_stack_union>,
  b_assoc_buffers = {
    next = 0xffff88007bf71528,
    prev = 0xffff88007bf71528
  },
  b_assoc_map = 0x0 <irq_stack_union>,
  b_count = {
    counter = 0x2
  }
}
```

ì•„ë˜ëŠ” í•„ë“œ í• ë‹¹ í›„ì˜ êµ¬ì¡°ì²´ì˜ ëª¨ìŠµì´ë‹¤.
`bs->s->base`ì™€ `bs->s->end`ê°€ ì„¤ì •ë˜ì–´ Heap ì˜ì—­ì— í• ë‹¹ëœ êµ¬ì¡°ì²´ì˜ ë²”ìœ„ë¥¼ ì•Œ ìˆ˜ ìˆì—ˆê³ , `first`ì™€ `here` í•„ë“œê°€ `lost+found entry`ë¥¼ ê°€ë¥´í‚¤ë©°, `NEXT(first)` ì—°ì‚°ì´ ëª‡ ì°¨ë¡€ ì´ë£¨ì–´ì§€ë©´ `0x9b9b9b9b` ì˜ì—­ì„ ì°¸ì¡°í•  ìˆ˜ ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```sh
gefâ¤  p *$2
$6 = {
  s = {
    first = 0xffff88007aab2c20,
    base = 0xffff88007aab2c00,
    end = 0xffff88007aab3000,
    here = 0xffff88007aab2c20,
    not_found = 0xffffffc3
  },
  bh = 0xffff88007bf714e0
}
gefâ¤  p *$2->bh
$5 = {
  b_state = 0x4000021,
  b_this_page = 0xffff88007bf71680,
  b_page = 0xffffea0001eaac80,
  b_blocknr = 0x23,
  b_size = 0x400,
  b_data = 0xffff88007aab2c00 "\002",
  b_bdev = 0xffff88007cc28340,
  b_end_io = 0x0 <irq_stack_union>,
  b_private = 0x0 <irq_stack_union>,
  b_assoc_buffers = {
    next = 0xffff88007bf71528,
    prev = 0xffff88007bf71528
  },
  b_assoc_map = 0x0 <irq_stack_union>,
  b_count = {
    counter = 0x2
  }
}

gefâ¤  x/128gx 0xffff88007aab2c00
0xffff88007aab2c00:	0x0201000c00000002	0x000000020000002e
0xffff88007aab2c10:	0x00002e2e0202000c	0x020a00140000000b
0xffff88007aab2c20:	0x756f662b74736f6c	0x0000000c0000646e
0xffff88007aab2c30:	0x006f6f660203000c	0x0201000c00000013
0xffff88007aab2c40:	0x0000005200000061	0x000000300101000c
0xffff88007aab2c50:	0x0101000c00000053	0x0000005400000031
0xffff88007aab2c60:	0x000000320101000c	0x0101000c00000055
0xffff88007aab2c70:	0x0000005600000033	0x000000340101000c
0xffff88007aab2c80:	0x0101000c00000057	0x0000005800000035
0xffff88007aab2c90:	0x000000360101000c	0xbabeccccbbaa0059
0xffff88007aab2ca0:	0xffffdeadbeefcafe	0x9b9b9b9b9b9bffff
0xffff88007aab2cb0:	0x9b9b9b9b9b9b9b9b	0x9b9b9b9b9b9b9b9b
0xffff88007aab2cc0:	0x9b9b9b9b9b9b9b9b	0x9b9b9b9b9b9b9b9b
0xffff88007aab2cd0:	0x9b9b9b9b9b9b9b9b	0x9b9b9b9b9b9b9b9b
...
0xffff88007aab2ff0:	0x9b9b9b9b9b9b9b9b	0x9b9b9b9b9b9b9b9b
0xffff88007aab3000:	0x0000000000000000	0x0000000000000000
```

## ext4_xattr_set_entry()

```
                                                       +--------------------+
                                                       |                    |
                                                       |                    |
                                                       |                    |
            ENTRY 01           ENTRY 02                |                    |
      +------------+-----+------------+-----+          |                    |
      |            |     |            |     |          |    OTHER OBJECT    |
      | e_name_len | ... | e_name_len | ... |          |                    |
      |            |     |            |     |          |                    |
      +------------+------------------+-----+          |                    |
      |                  ^                             |                    |
      |                  |                             |                    |
      |                  |                       +---->---------------------+
      +------------------+                       |     |                    |
                                                 |     |      ENTRY  N      |
    EXT4_XATTR_NEXT(ENTRY_01)                    |     |                    |
                                                 |     +--------------------+  <+ EXT4_XATTR_NEXT(ENTRY N-1)
((&ENTRY_01) + e_name_len + 0x0f)                |     |                    |
                                                 |     |      ENTRY N-1     |
                                                 |     |                    |
                                                 |     +--------------------+
                                                 |     *                    *
                                                 |     *                    *
                                                 |     *                    *
     struct ext4_xattr_search                    |     +--------------------+
                                                 |     |                    |
 +------------------------------+                |     |      ENTRY 03      |
 |            first             +-----+          |     |                    |
 +------------------------------+     |          |     +--------------------+ <+ EXT4_XATTR_NEXT(ENTRY 02)
 |            base              |     |          |     |                    |
 +------------------------------+     |          |     |      ENTRY 02      |
 |             end              +----------------+     |                    |
 +------------------------------+     |                +--------------------+ <+ EXT4_XATTR_NEXT(ENTRY 01)
 |            here              |     |                |                    |
 +------------------------------+     +--------------->+      ENTRY 01      |
 |          not_found           |                      |                    |
 +------------------------------+                      +--------------------+
31                            0
```



<!--
í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ 0xD0a0 ìœ„ì¹˜ì— data entry ì¡´ì¬. (0x44 )


gefâ¤  p *(struct ext4_xattr_entry *)0xffff8800799d04a4
$16 = {
  e_name_len = 0x4,
  e_name_index = 0x7,
  e_value_offs = 0x18,
  e_value_inum = 0x0,
  e_value_size = 0x44,
  e_hash = 0x0,
  e_name = 0xffff8800799d04b4 "data"
}


00 00 02 EA 04 07 18 00 00 00 00 00 44 00 00 00 00 00 00 00 64 61 74 61 00 00 00 00 0E 00 00 00 0C 00 03 01 68 6C 6E 00 12 00 00 00 38 00 03 07
ï¿½ï¿½Ãªï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½dataï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½hlnï¿½ï¿½ï¿½ï¿½8ï¿½


í•´ë‹¹ ê°’ì´ controlable? ì¡°ì ˆ ê°€ëŠ¥í•˜ë©´ ëŒ€ë°•ì“° ì•ˆë ê°€ëŠ¥ì„± ë†’ìŒ
e_value_sizeëŠ” ì²´í¬ ì¡´ì¬í•˜ëŠ”ë“¯
-->

OOB Writeë˜ëŠ” ì£¼ì†Œì— í• ë‹¹ë˜ìˆë˜ ê°’ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
syslog ê´€ë ¨ objectë¡œ ì¶”ì •ë˜ë©°, ê° ì˜¤ë¸Œì íŠ¸ í¬ê¸°ëŠ” `block`í¬ê¸°ì™€ ë™ì¼í•œ `0x400`ì´ë‹¤.

```
gefâ¤  x/32gx 0xffff88007b773400
0xffff88007b773400:	0xffff88007b770c00	0x4f4c5359530a373d
0xffff88007b773410:	0x494c494341465f47	0x444f430a333d5954
0xffff88007b773420:	0x2e3d454c49465f45	0x64752f6372732f2e
0xffff88007b773430:	0x2d766564752f7665	0x0a632e73656c7572
0xffff88007b773440:	0x4e494c5f45444f43	0x430a363032323d45
0xffff88007b773450:	0x434e55465f45444f	0x6564753d4e4f4954
0xffff88007b773460:	0x5f73656c75725f76	0x6f745f796c707061
0xffff88007b773470:	0x530a746e6576655f	0x44495f474f4c5359
0xffff88007b773480:	0x5245494649544e45	0x646d65747379733d
0xffff88007b773490:	0x4d0a64766564752d	0x473d454741535345
0xffff88007b7734a0:	0x2f20352050554f52	0x766564752f62696c
0xffff88007b7734b0:	0x642e73656c75722f	0x766564752d30352f
0xffff88007b7734c0:	0x746c75616665642d	0x323a73656c75722e
0xffff88007b7734d0:	0x647562696c2f0a35	0x63697665642d7665
0xffff88007b7734e0:	0x2c3832313a632e65	0x6f6974636e756620
0xffff88007b7734f0:	0x645f76656475206e	0x65675f6563697665
```

ì´ ê°’ì„ í™•ì¸í•´ë³´ë©´, `400`ìœ„ì¹˜ì—ëŠ” ì–´ë–¤ í¬ì¸í„°ê°€, `408` ìœ„ì¹˜ë¶€í„°ëŠ” ë¬¸ìì—´ì´ ì¡´ì¬í•œë‹¤.

```
gefâ¤  x/s 0xffff88007b773408
0xffff88007b773408:	"=7\nSYSLOG_FACILITY=3\nCODE_FILE=../src/udev/udev-rules.c\nCODE_LINE=2206\nCODE_FUNCTION=udev_rules_apply_to_event\nSYSLOG_IDENTIFIER=systemd-udevd\nMESSAGE=GROUP 5 /lib/udev/rules.d/50-udev-default.rules:25\n/libudev-device.c:128, function udev_device_get_driver(). Ignoring.\n"
```

`400`ìœ„ì¹˜ì˜ í¬ì¸í„°ë¥¼ ë”°ë¼ê°€ ë³´ë©´, ì—°ê²° ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ê°ê°ì˜ ë¡œê·¸ ë¬¸ìì—´ì„ ì°¸ì¡°í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.
```
gefâ¤  x/gx 0xffff88007b770c00
0xffff88007b770c00:	0xffff88007b772000
gefâ¤  x/a 0xffff88007b770c00
0xffff88007b770c00:	0xffff88007b772000
gefâ¤  x/a 0xffff88007b772000
0xffff88007b772000:	0xffff88007b773800
gefâ¤  x/a 0xffff88007b773800
0xffff88007b773800:	0xffff88007b772c00
gefâ¤  x/a 0xffff88007b772c00
0xffff88007b772c00:	0xffff88007b770800
gefâ¤  x/a 0xffff88007b770800
0xffff88007b770800:	0xffff88007b770000
gefâ¤  x/a 0xffff88007b770000
0xffff88007b770000:	0xffff88007b771800
gefâ¤
0xffff88007b770008:	0x4f4c5359530a373d
gefâ¤
0xffff88007b770010:	0x494c494341465f47
gefâ¤
0xffff88007b770018:	0x444f430a333d5954
gefâ¤  x/s 0xffff88007b770008
0xffff88007b770008:	"=7\nSYSLOG_FACILITY=3\nCODE_FILE=../src/udev/udev-node.c\nCODE_LINE=344\nCODE_FUNCTION=udev_node_add\nSYSLOG_IDENTIFIER=systemd-udevd\nMESSAGE=handling device node '/dev/tty4', devnum=c4:4, mode=0620, uid=0, gid=5\n79290\nSystem Message Bus Socket.\nRESULT=done\n"
gefâ¤
```

ì´í›„ íë¦„ì„ ì­‰ ë”°ë¼ê°ˆ ê²½ìš° `OOB Write`ê°€ ë°œìƒí•˜ì—¬ ì•„ë˜ì™€ ê°™ì€ ë©”ëª¨ë¦¬ ë³€ê²½ì„ ì¼ìœ¼í‚¨ë‹¤.

```
gefâ¤  x/32gx 0xffff88007b773400
0xffff88007b773400:	0xcafebabedeadbeef	0xcafebabedeadbeef
0xffff88007b773410:	0x7b770c00deadbeef	0x530a373dffff8800
0xffff88007b773420:	0x41465f474f4c5359	0x333d5954494c4943
0xffff88007b773430:	0x49465f45444f430a	0x72732f2e2e3d454c
0xffff88007b773440:	0x752f766564752f63	0x656c75722d766564
0xffff88007b773450:	0x45444f430a632e73	0x32323d454e494c5f
0xffff88007b773460:	0x5f45444f430a3630	0x4e4f4954434e5546
0xffff88007b773470:	0x75725f766564753d	0x6c7070615f73656c
0xffff88007b773480:	0x6576655f6f745f79	0x4f4c5359530a746e
0xffff88007b773490:	0x49544e4544495f47	0x7379733d52454946
0xffff88007b7734a0:	0x6564752d646d6574	0x415353454d0a6476
0xffff88007b7734b0:	0x50554f52473d4547	0x2f62696c2f203520
0xffff88007b7734c0:	0x6c75722f76656475	0x2d30352f642e7365
0xffff88007b7734d0:	0x6665642d76656475	0x6c75722e746c7561
0xffff88007b7734e0:	0x6c2f0a35323a7365	0x642d766564756269
0xffff88007b7734f0:	0x3a632e6563697665	0x6e7566202c383231
gefâ¤
```

## 10/08 16:42
í•´ë‹¹ êµ¬ì¡°ì²´ë“¤ì€ ëª¨ë‘ ì—°ê²° ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë£¨ì–´ì ¸ ìˆìŒ.
ê° êµ¬ì¡°ì²´ë§ˆë‹¤ ìœ„ì— ëª…ì‹œí–ˆë“¯ ë¡œê·¸ ë¬¸ìì—´ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ê°€ì¥ ìµœê·¼ì— í• ë‹¹ëœ ë©”ëª¨ë¦¬ì—ëŠ” í¬ì¸í„°ê°€ NULLì„.
ë”°ë¼ì„œ ìƒˆë¡œìš´ ë¡œê·¸ ë¬¸ìì—´ì´ í• ë‹¹ë  ë•Œ ìš°ë¦¬ê°€ ì ì–´ì¤€ ì£¼ì†Œì˜ í¬ì¸í„°ì— ìƒˆë¡œ í• ë‹¹í•œ ë¡œê·¸ ë¬¸ìì—´ ì²­í¬ì˜ ì£¼ì†Œë¥¼ ì ì–´ì£¼ëŠ”ë“¯?

í…ŒìŠ¤íŠ¸ ì‚¼ì•„ 0x1234123412341234 ìœ„ì¹˜ì— í• ë‹¹ í›„ í•´ë‹¹ ì£¼ì†Œ í™•ì¸í•´ë³´ëŠ”ê±¸ë¡œ

```
[  185.454859] EXT4-fs (loop0): mounted filesystem with ordered data mode. Opts: (null)
[  185.899817] ==================================================================
[  185.900525] BUG: KASAN: slab-out-of-bounds in ext4_xattr_free_space+0x200/0x300
[  185.900525] Read of size 4 at addr ffff88006bf110dc by task poc/1814
[  185.900525]
[  185.900525] CPU: 0 PID: 1814 Comm: poc Not tainted 4.17.0 #8
[  185.900525] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014
[  185.900525] Call Trace:
[  185.900525]  dump_stack+0xc2/0x16b
[  185.900525]  ? show_regs_print_info+0x5/0x5
[  185.900525]  ? kmsg_dump_rewind_nolock+0xd4/0xd4
[  185.900525]  ? finish_task_switch+0x2c8/0x930
[  185.900525]  print_address_description+0x6e/0x280
[  185.900525]  kasan_report+0x253/0x380
[  185.900525]  ? ext4_xattr_free_space+0x200/0x300
[  185.900525]  ext4_xattr_free_space+0x200/0x300
[  185.900525]  ext4_expand_extra_isize_ea+0x1140/0x17f0
[  185.900525]  ? __schedule+0x712/0x17b0
[  185.900525]  ? pci_mmcfg_check_reserved+0x100/0x100
[  185.900525]  ? ext4_xattr_set+0x330/0x330
[  185.900525]  ? __ext4_get_inode_loc+0x3d0/0xeb0
[  185.900525]  ? jbd2_journal_free_transaction+0x20/0x20
[  185.900525]  ? __jbd2_journal_temp_unlink_buffer+0x4f0/0x530
[  185.900525]  ? other_inode_match+0x9c0/0x9c0
[  185.900525]  __ext4_expand_extra_isize+0x152/0x280
[  185.900525]  ext4_mark_inode_dirty+0x5ff/0x870
[  185.900525]  ? ext4_expand_extra_isize+0x4c0/0x4c0
[  185.900525]  ? ext4_generic_delete_entry+0x1ad/0x470
[  185.900525]  ? up_read+0x20/0x20
[  185.900525]  ext4_delete_inline_entry+0x33c/0x590
[  185.900525]  ? ext4_find_inline_entry+0x400/0x400
[  185.900525]  ? ext4_expand_extra_isize+0x4c0/0x4c0
[  185.900525]  ext4_delete_entry+0x2e0/0x460
[  185.900525]  ? ext4_generic_delete_entry+0x470/0x470
[  185.900525]  ext4_rename+0x1fca/0x2f60
[  185.900525]  ? ext4_tmpfile+0x400/0x400
[  185.900525]  ? ext4_find_entry+0x80a/0xef0
[  185.900525]  ? __d_alloc+0x63d/0xc60
[  185.900525]  ? lockref_get+0x1b2/0x310
[  185.900525]  ? blk_mq_debugfs_unregister_sched_hctx+0x70/0x70
[  185.900525]  ? take_dentry_name_snapshot+0xbb/0x270
[  185.900525]  vfs_rename+0x9d0/0x1810
[  185.900525]  ? vfs_link+0xaa0/0xaa0
[  185.900525]  ? __d_lookup+0x700/0x700
[  185.900525]  ? ext4_cross_rename+0x2040/0x2040
[  185.900525]  do_renameat2+0x9a6/0xec0
[  185.900525]  ? user_path_create+0x30/0x30
[  185.900525]  ? cpumask_weight.constprop.2+0x35/0x35
[  185.900525]  ? _cond_resched+0x12/0x60
[  185.900525]  ? downgrade_write+0x1a0/0x1a0
[  185.900525]  ? rcu_note_context_switch+0x440/0x440
[  185.900525]  ? __do_page_fault+0x47a/0xa60
[  185.900525]  __x64_sys_rename+0x55/0x80
[  185.900525]  ? exit_to_usermode_loop+0x117/0x1a0
[  185.900525]  do_syscall_64+0x137/0x430
[  185.900525]  ? syscall_return_slowpath+0x2e0/0x2e0
[  185.900525]  ? do_page_fault+0x90/0x360
[  185.900525]  ? __do_page_fault+0xa60/0xa60
[  185.900525]  ? prepare_exit_to_usermode+0x1ae/0x200
[  185.900525]  ? perf_trace_sys_enter+0x1050/0x1050
[  185.900525]  ? __put_user_4+0x1c/0x30
[  185.900525]  entry_SYSCALL_64_after_hwframe+0x44/0xa9
[  185.900525] RIP: 0033:0x7fd421b75d47
[  185.900525] RSP: 002b:00007ffe1a6ea488 EFLAGS: 00000206 ORIG_RAX: 0000000000000052
[  185.900525] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007fd421b75d47
[  185.900525] RDX: 000055c7cab670a0 RSI: 000055c7cab670a0 RDI: 000055c7cab67080
[  185.900525] RBP: 00007ffe1a6ea4c0 R08: 000055c7cab67010 R09: 0000000000000000
[  185.900525] R10: 0000000000000642 R11: 0000000000000206 R12: 000055c7ca8555d0
[  185.900525] R13: 00007ffe1a6ea5c0 R14: 0000000000000000 R15: 0000000000000000
[  185.900525]
[  185.900525] Allocated by task 1354:
[  185.900525]  kasan_kmalloc+0xa0/0xd0
[  185.900525]  kmem_cache_alloc+0xbf/0x190
[  185.900525]  mempool_alloc+0x119/0x380
[  185.900525]  bio_alloc_bioset+0x347/0x650
[  185.900525]  mpage_alloc.isra.10+0x58/0x270
[  185.900525]  do_mpage_readpage+0xeef/0x16e0
[  185.900525]  mpage_readpages+0x3a1/0x6e0
[  185.900525]  __do_page_cache_readahead+0x51b/0x9f0
[  185.925035]  force_page_cache_readahead+0x1b7/0x310
[  185.925035]  generic_file_read_iter+0x11ca/0x1f70
[  185.925035]  __vfs_read+0x548/0x810
[  185.925035]  vfs_read+0xdc/0x2d0
[  185.925035]  ksys_read+0xcb/0x1e0
[  185.925035]  do_syscall_64+0x137/0x430
[  185.925035]  entry_SYSCALL_64_after_hwframe+0x44/0xa9
[  185.925035]
[  185.925035] Freed by task 1808:
[  185.925035]  __kasan_slab_free+0x12e/0x180
[  185.925035]  kmem_cache_free+0x70/0x1a0
[  185.925035]  bio_put+0x123/0x180
[  185.925035]  bio_endio+0x2c9/0x5c0
[  185.925035]  blk_update_request+0x1e2/0xb10
[  185.925035]  blk_mq_end_request+0x48/0x100
[  185.925035]  __blk_mq_complete_request+0x501/0x800
[  185.925035]  blk_mq_complete_request+0x1b5/0x2e0
[  185.925035]  loop_queue_work+0x218/0x38a0
[  185.925035]  kthread_worker_fn+0x370/0x7c0
[  185.925035]  kthread+0x2d6/0x390
[  185.925035]  ret_from_fork+0x35/0x40
[  185.925035]
[  185.925035] The buggy address belongs to the object at ffff88006bf11000
[  185.925035]  which belongs to the cache bio-0 of size 176
[  185.925035] The buggy address is located 44 bytes to the right of
[  185.925035]  176-byte region [ffff88006bf11000, ffff88006bf110b0)
[  185.925035] The buggy address belongs to the page:
[  185.925035] page:ffffea0001afc440 count:1 mapcount:0 mapping:0000000000000000 index:0x0
[  185.925035] flags: 0x100000000000100(slab)
[  185.925035] raw: 0100000000000100 0000000000000000 0000000000000000 0000000180100010
[  185.925035] raw: dead000000000100 dead000000000200 ffff88006c353140 0000000000000000
[  185.925035] page dumped because: kasan: bad access detected
[  185.925035]
[  185.925035] Memory state around the buggy address:
[  185.925035]  ffff88006bf10f80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[  185.925035]  ffff88006bf11000: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[  185.925035] >ffff88006bf11080: fb fb fb fb fb fb fc fc fc fc fc fc fc fc fc fc
[  185.925035]                                                     ^
[  185.925035]  ffff88006bf11100: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[  185.925035]  ffff88006bf11180: fb fb fb fb fb fb fc fc fc fc fc fc fc fc fc fc
[  185.925035] ==================================================================
[  185.925035] Disabling lock debugging due to kernel taint
[  185.993116] EXT4-fs error (device loop0): ext4_xattr_inode_iget:390: comm poc: error while reading EA inode 1970234923 err=-117
```


## 10/09

ì§€ê¸ˆê¹Œì§€ ì •ë¦¬ëœ ë‚´ìš©ì€ ì•„ë˜ì™€ ê°™ë‹¤.

(1) set_entryì—ì„œ ì‚¬ìš©í•˜ëŠ” heap object size: 1K
(2) (1)ì˜ ë©”ëª¨ë¦¬ ë’¤ì— ì¡´ì¬í•˜ëŠ” heap object sizeë„ 1K
(3) ì·¨ì•½ì  íŠ¸ë¦¬ê±°ë§ ì´í›„ (2) ì˜¤ë¸Œì íŠ¸ì˜ ì• 0x10Byteë¥¼ Overwrite ê°€ëŠ¥
(4) ë¶„ì„ ê²°ê³¼ (2) ì˜¤ë¸Œì íŠ¸ëŠ” syslog objectì¼ í™•ë¥ ì´ ë†’ìœ¼ë©°, freeë˜ì—ˆì„ ê²½ìš° freelist(ì—°ê²°ë¦¬ìŠ¤íŠ¸) ê´€ë¦¬ë¥¼ ìœ„í•´ ì• 8ë°”ì´íŠ¸ì— ë‹¤ìŒ free'd chunk ì£¼ì†Œë¥¼ ê°€ì§€ê³  ìˆìŒ.
	-> í¬ë˜ì‹œê°€ í„°ì§€ëŠ”ê±¸ ë³´ë©´ slab_allocí•˜ëŠ” ì¤‘, freelistë¥¼ ì­‰ ìˆœíšŒí•˜ë‹¤ê°€ corruptedëœ freelist ptrë¥¼ ì°¸ì¡°í•˜ì—¬ page fault


gdbë¡œ í™•ì¸í•´ë³´ë©´,


* set_entryì—ì„œ bpê±¸ë ¸ì„ ë•Œ search êµ¬ì¡°ì²´
```
$19 = {
  first = 0xffff88007bbe7420,
  base = 0xffff88007bbe7400,
  end = 0xffff88007bbe7800,
  here = 0xffff88007bbe7420,
  not_found = 0xffffffc3
}
```

* í•´ë‹¹ êµ¬ì¡°ì²´ ì˜ì—­ ë‹¤ìŒì˜ ë‚´ìš©(`s->end`ë¶€í„°ì˜ ë‚´ìš©)
```
gefâ¤  x/s 0xffff88007bbe7800
0xffff88007bbe7800:	"PRIORITY=7\nSYSLOG_FACILITY=4\nCODE_FILE=../src/libsystemd/sd-bus/sd-bus.c\nCODE_LINE=2537\nCODE_FUNCTION=process_message\nSYSLOG_IDENTIFIER=systemd-logind\nMESSAGE=Got message type=signal sender=:1.0 destination=n/a object=/org/freedesktop/systemd1 interface=org.freedesktop.systemd1.Manager member=UnitRemoved cookie=173 reply_cookie=0 error=n/a\ne=170 reply_cookie=0 error=n/a\n.Properties member=PropertiesChanged cookie=130 reply_cookie=0 error=n/a\n"
```

* ì‹œê°„ì´ ì ì‹œ ì§€ë‚œ í›„ ê°™ì€ ë©”ëª¨ë¦¬ì˜ ë‚´ìš©
```
gefâ¤  x/32gx 0xffff88007bbe7800
0xffff88007bbe7800:	0xffff88007bbe7400	0x1234123412343400
0xffff88007bbe7810:	0x4f495250deadbeef	0x530a373d59544952
0xffff88007bbe7820:	0x41465f474f4c5359	0x343d5954494c4943
...
```


* `0xffff88007bbe7800`ì— ìœ„ì¹˜í•˜ëŠ” í¬ì¸í„°ê°€ ê°€ë¥´í‚¤ëŠ” ì£¼ì†Œì˜ ê°’
```
gefâ¤  x/32gx 0xffff88007bbe7400
0xffff88007bbe7400:	0xffff88007bbe5000	0x1e1292ff0000002e
0xffff88007bbe7410:	0x00002e2e0202000c	0x020a00140000000b
0xffff88007bbe7420:	0x0000000003bc0704	0xe1e16d0000000044
```

* overwriteí•œ ì£¼ì†Œë¥¼ accessí•œ í›„ í¬ë˜ì‹œê°€ í„°ì§€ëŠ” ìƒí™©ì—ì„œì˜ Call Trace
```
#0  slab_alloc_node (addr=<optimized out>, node=<optimized out>, gfpflags=<optimized out>, s=<optimized out>) at mm/slub.c:2726
#1  __kmalloc_node_track_caller (size=0x23ac0, gfpflags=0x15106c0, node=0xd89, caller=<optimized out>) at mm/slub.c:4364
#2  0xffffffff81992619 in __kmalloc_reserve (size=0x2c0, flags=0x15004c0, node=0xffffffff, pfmemalloc=0xffffc9000031fb67, ip=<optimized out>) at net/core/skbuff.c:137
#3  0xffffffff819936ad in __alloc_skb (size=<optimized out>, gfp_mask=0x15106c0, flags=<optimized out>, node=0xd8a) at net/core/skbuff.c:205
#4  0xffffffff8199470f in alloc_skb (priority=<optimized out>, size=<optimized out>) at ./include/linux/skbuff.h:987
#5  alloc_skb_with_frags (header_len=<optimized out>, data_len=0x0, max_page_order=0x3, errcode=<optimized out>, gfp_mask=0x15000c0) at net/core/skbuff.c:5249
#6  0xffffffff8198e568 in sock_alloc_send_pskb (sk=0xffff88007b5a6400, header_len=<optimized out>, data_len=<optimized out>, noblock=<optimized out>, errcode=0xffffc9000031fca0, max_page_order=<optimized out>) at net/core/sock.c:2088
#7  0xffffffff81a7a2e2 in unix_dgram_sendmsg (sock=0xffff88007bd26500, msg=0xffffc9000031fec0, len=0x151) at net/unix/af_unix.c:1672
#8  0xffffffff81989881 in sock_sendmsg_nosec (msg=<optimized out>, sock=<optimized out>) at net/socket.c:629
#9  sock_sendmsg (sock=0xffff88007bd26500, msg=0xffffc9000031fec0) at net/socket.c:639
#10 0xffffffff81989e2a in ___sys_sendmsg (sock=0xffff88007bd26500, msg=<optimized out>, msg_sys=0xffffc9000031fec0, flags=0x4000, used_address=<optimized out>, allowed_msghdr_flags=<optimized out>) at net/socket.c:2117
#11 0xffffffff8198b079 in __sys_sendmsg (fd=<optimized out>, msg=0x15106c0, flags=0xd89, forbid_cmsg_compat=<optimized out>) at net/socket.c:2155
#12 0xffffffff810023c9 in do_syscall_64 (nr=<optimized out>, regs=0x15106c0) at arch/x86/entry/common.c:287
#13 0xffffffff81c00088 in entry_SYSCALL_64 () at arch/x86/entry/entry_64.S:238
#14 0x0000000000000000 in ?? ()
```

ì´ë¡œì¨ ìœ„ì™€ ê°™ì€ ê²°ê³¼ê°€ ë„ì¶œë˜ì—ˆë‹¤.
